from qgis.core import QgsVectorLayer, QgsField, QgsFeature, QgsGeometry, QgsProject, QgsWkbTypes

CamadaTrechoDrenagem = QgsProject.instance().mapLayersByName("dados_projeto1_2024 — elemnat_trecho_drenagem_l")[0]
CamadaViaDeslocamento = QgsProject.instance().mapLayersByName("dados_projeto1_2024 — infra_via_deslocamento_l")[0]

nome_camada = "TrechoDrenagemNoBuffer"
uri = "LineString?crs={}".format(CamadaTrechoDrenagem.crs().authid())
camada_trecho_drenagem_no_buffer = QgsVectorLayer(uri, nome_camada, "memory")

camada_trecho_drenagem_no_buffer.startEditing()
camada_trecho_drenagem_no_buffer.addAttribute(QgsField("ID", QVariant.Int))
camada_trecho_drenagem_no_buffer.updateFields()

for feature in CamadaTrechoDrenagem.getFeatures():
    geom = feature.geometry()
    buffer = geom.buffer(50, -1)  # Buffer de 50 unidades
    for featDrena in CamadaViaDeslocamento.getFeatures():
        geomDrena = featDrena.geometry()
        if geomDrena.intersects(buffer):
            # Adicionando os trechos de drenagem que intersectam com o buffer à camada
            nova_feature = QgsFeature()
            nova_feature.setGeometry(geomDrena)
            nova_feature.setAttributes([featDrena.id()])
            camada_trecho_drenagem_no_buffer.addFeature(nova_feature)

camada_trecho_drenagem_no_buffer.commitChanges()

QgsProject.instance().addMapLayer(camada_trecho_drenagem_no_buffer)
